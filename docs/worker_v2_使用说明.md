# Worker V2 使用说明

## 🎉 新增功能

### ✅ 已实现的功能

1. **验证码功能** 🔐
   - 用户第一次发送消息时自动弹出验证码
   - 验证正确后才会转发消息给管理员
   - 验证失败消息不会转发
   - 验证码5分钟内有效
   - 验证成功后永久有效

2. **自动回复功能** 🤖
   - 根据关键词自动回复用户
   - 支持正则表达式匹配
   - 管理命令：`/addreply`, `/delreply`, `/listreply`

3. **快捷操作功能** ⚡
   - 转发消息下方显示内联操作按钮
   - 支持快速标记、屏蔽、查看状态等操作
   - 支持快捷回复功能

4. **帮助命令** 📖
   - `/help` - 显示详细使用教程
   - `/menu` - 显示命令菜单
   - 输入框旁边显示快捷按钮

5. **命令菜单按钮** 📋
   - 在输入框旁边显示固定菜单
   - 快速访问常用功能
   - 包括：使用教程、命令列表、自动回复管理、快捷回复管理

## 📝 功能详解

### 1. 验证码功能

**工作原理**：
- 用户第一次发送消息时，系统自动生成4位数字验证码
- 验证码通过消息发送给用户
- 用户直接输入4位数字验证码完成验证（无需输入命令）
- 验证成功后，用户消息才会转发给管理员
- 验证失败，消息不会转发

**验证流程**：
1. 用户发送消息 → 系统检测未验证
2. 系统生成验证码并发送给用户
3. 用户直接输入4位数字验证码（如：1234）
4. 系统验证验证码
5. 验证成功 → 标记用户已验证 → 后续消息正常转发
6. 验证失败 → 提示错误，消息不转发

**配置参数**（在代码顶部）：
```javascript
const VERIFY_CODE_EXPIRE = 300 * 1000; // 验证码5分钟过期
```

**使用方法**：
- 收到验证码后，直接输入4位数字即可验证（无需输入 `/verify` 命令）

### 2. 自动回复功能

**使用方法**：

添加自动回复：
```
/addreply 你好 您好，有什么可以帮助您的吗？
```

删除自动回复：
```
/delreply 你好
```

查看所有自动回复：
```
/listreply
```

**特性**：
- 支持正则表达式（如 `/addreply /^hello/i 你好`）
- 自动回复后仍会转发给管理员
- 关键词不区分大小写（默认）

### 3. 快捷操作功能

**内联按钮功能**：

当用户消息转发给你时，会自动显示操作按钮：

- **✅ 已回复** - 标记消息为已回复
- **🚫 屏蔽用户** - 快速屏蔽该用户
- **🔓 解除屏蔽** - 解除用户屏蔽
- **📋 查看状态** - 查看用户和消息状态
- **💬 快捷回复** - 使用预设快捷回复

**快捷回复**：

系统预设了3个快捷回复：
- 收到 - "收到，我会尽快处理"
- 稍等 - "请稍等，正在处理中"
- 已处理 - "已处理完成"

**自定义快捷回复**：

添加自定义快捷回复：
```
/addquickreply 收到 收到，我会尽快处理
```

删除快捷回复：
```
/delquickreply 收到
```

### 4. 帮助命令

**命令**：
- `/help` - 显示详细使用教程
- `/menu` - 显示命令菜单（同 /help）

**内容**：
- 基础功能介绍
- 所有可用命令
- 使用技巧

### 5. 命令菜单按钮

**位置**：输入框旁边（仅管理员可见）

**按钮功能**：
- **📖 使用教程** - 显示帮助信息
- **📋 命令列表** - 显示所有命令
- **🤖 自动回复管理** - 查看自动回复列表
- **💬 快捷回复管理** - 查看快捷回复列表

## 🚀 部署步骤

1. **复制代码**
   - 打开 `worker_v2.js`
   - 复制全部内容

2. **部署到 Cloudflare Workers**
   - 登录 Cloudflare Workers
   - 选择你的 Worker
   - 点击"快速编辑"
   - 粘贴代码
   - 点击"保存并部署"

3. **配置环境变量**（如果还没配置）
   - `ENV_BOT_TOKEN` - Bot Token
   - `ENV_BOT_SECRET` - Secret UUID          https://www.uuidgenerator.net/
   - `ENV_ADMIN_UID` - 管理员用户 ID

4. **注册 Webhook**
   - 访问 `https://your-worker.workers.dev/registerWebhook`

## 📋 命令列表

### 管理员命令

**屏蔽管理**：
- `/block` - 屏蔽用户（回复消息）
- `/unblock` - 解除屏蔽（回复消息）
- `/checkblock` - 检查屏蔽状态（回复消息）

**自动回复**：
- `/addreply <关键词> <回复>` - 添加自动回复
- `/delreply <关键词>` - 删除自动回复
- `/listreply` - 列出所有自动回复

**快捷回复**：
- `/addquickreply <名称> <内容>` - 添加快捷回复
- `/delquickreply <名称>` - 删除快捷回复

**其他**：
- `/help` - 显示使用教程
- `/menu` - 显示命令菜单
- `/start` - 开始使用（显示欢迎消息和菜单）

### 用户命令

- `/start` - 开始使用
- 首次使用需要验证：收到验证码后直接输入4位数字即可

## 💡 使用技巧

### 1. 快速操作
- 使用内联按钮，无需输入命令
- 点击"快捷回复"可快速回复常用内容

### 2. 自动回复设置
- 设置常见问题的自动回复
- 使用正则表达式匹配更灵活

### 3. 快捷回复管理
- 添加常用的回复模板
- 通过按钮快速发送

### 4. 命令菜单
- 点击输入框旁的按钮快速访问功能
- 无需记忆命令

## 🔧 保留的原有功能

以下功能完全保留，未做修改：

- ✅ 消息转发
- ✅ 管理员回复
- ✅ 用户屏蔽/解封
- ✅ 诈骗检测
- ✅ 消息通知

## ⚠️ 注意事项

1. **验证码功能**：
   - 验证码5分钟内有效，过期需重新发送消息获取
   - 验证成功后永久有效，无需重复验证
   - 验证失败的消息不会转发给管理员

2. **自动回复**：自动回复后消息仍会转发，确保你不会错过重要消息

3. **快捷回复**：系统预设的快捷回复无法删除，只能删除自定义的

4. **内联按钮**：按钮只在转发消息时显示，普通消息不会显示

5. **命令菜单**：只有管理员能看到命令菜单按钮

## 🐛 常见问题

**Q: 为什么看不到命令菜单按钮？**
A: 确保你是管理员，并且发送过 `/start` 或 `/help` 命令。

**Q: 快捷回复按钮点击没反应？**
A: 检查是否正确设置了 KV 命名空间 `nfd`。

**Q: 自动回复不生效？**
A: 检查关键词是否正确，支持正则表达式时注意转义。

**Q: 验证码收不到？**
A: 检查网络连接，验证码会在用户第一次发送消息时自动发送。

**Q: 验证码过期了怎么办？**
A: 重新发送一条消息，系统会自动生成新的验证码。


如有问题，请检查：
1. Cloudflare Workers 日志
2. KV 命名空间是否正确绑定
3. 环境变量是否正确配置
4. Webhook 是否已注册

